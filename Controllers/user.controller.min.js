/* eslint-disable no-undef */
/* eslint-disable no-unused-vars */
import Vote from '../Models/vote.model.min.js'
import Movie from '../Models/movie.model.min.js'
import User from '../Models/user.model.min.js'
import { nanoid } from 'nanoid'
import bcryptjs from 'bcryptjs'
import jwt from 'jsonwebtoken'
import crypto from 'crypto'
import { log } from 'console'

const usercontroller = {
    register: async(req, res)=>{
        try {
            const {email, password, name, role} = req.body;
            const user = await User.findOne({email})
            if(user){
                return res.status(400).json({message:"User already exists"})

            } 
          
            // console.log(salt)
            const hashPassword = await bcryptjs.hash(password, 16)
            // console.log(hashPassword);
            const token = await crypto.randomBytes(10).toString('hex')
            // console.log(token);
            // console.log(token);
            
            const newUser = new User({email, password:hashPassword, name, role, token})
            // console.log(newUser);
            
            await newUser.save()
            res.status(200).json({message:"Account created successfully", newUser})
            
        } catch (error) {
            res.status(500).json({message:"Server Error"})
        }
    },
    login: async (req, res) =>{
        const {email, password} = req.body;

        // console.log(email, password)
        try{
        const user = await User.findOne({email})
        // console.log(user)
        if(!user){
            return res.status(400).json({message:"User not found"})
        }

           
            const isMatch = await bcryptjs.compare(password, user.password)
            //    log(isMatch)
            if(!isMatch){
                return res.status(401).json({message:"Invalid credentials"})
            }
            const token = jwt.sign({
                name: user.name,
                id: user._id
            }, process.env.secret)
            // log(token)
            res.cookie('token', token, {
                httpOnly: true,
                sameSite: 'strict',
                expires: new Date(Date.now() + 24 * 60 * 60 * 1000),
                secure: true,
            })
            res.status(200).json({message:"Logged in successfully", token, user})
            
        
            
    } catch (error) {
     res.status(500).json({message:"Server Error"})       
    }},
    addMovie: async(req, res)=>{
        const {title, year, rating, image} = req.body
        const userId = req.userId
        console.log(userId)
        const user = await User.findById(userId)
        log(user)
        let arr=user.movie
        console.log(arr)
       
        try {
            const newMovie = new Movie({title, year, rating, image, userId})
            await newMovie.save()
            const vote1 = new Vote({userId:userId, movie1:{movieId:newMovie._id}})
            log(vote1)
            // const userMovieUpdate = await User.findByIdAndUpdate(userId,{movie})
            await vote1.save()
            arr.push(vote1._id)
            await User.findByIdAndUpdate(userId,{movie:arr})
            log(arr)
            res.status(200).json({message:"Movie added", newMovie, vote1})
            
        } catch (error) {
            res.status(500).json({message:"Server Error"})
        }
    },
    addMovie2: async(req, res)=>{
        const {title, year, rating, image} = req.body
        const {voteId} = req.params
        const userId = req.userId
        console.log(userId)
       
        
        try {
            const newMovie = new Movie({title, year, rating, image, userId})
            log(newMovie)
            await newMovie.save()
          
            const vote2 = await Vote.findOneAndUpdate({_id:voteId}, {movie2 : {movieId:newMovie._id}, percentage:0})
            console.log(vote2);
            
            await vote2.save()
            res.status(200).json({message:"Movie added", newMovie,vote2})
            
        } catch (error) {
            res.status(500).json({message:"Server Error"})
        }
    },
    voteMovie1:async(req,res)=>{
        const {movieId1} = req.body
        const {voteId} = req.params
        log(movieId1, voteId)
        const vote = await Vote.findById(voteId);
        log(vote)
      log(vote.movie1.movieId.toString())
      if(vote.movie1.movieId.toString() !== movieId1){
        return res.status(400).json({message:"Invalid ID"})
      }
          vote.movie1.percentage += 1;
        // log(movieUpdate1)
        await vote.save()
        res.status(200).json({message:"Movie voted", vote})
    },
    voteMovie2:async(req,res)=>{
        const {movieId2} = req.body
        const {voteId} = req.params
        const vote = await Vote.findById(voteId);
       
        if(vote.movie2.movieId.toString() !== movieId2){
            return res.status(400).json({message:"Invalid ID"})
          }
              vote.movie2.percentage += 1;
            // log(movieUpdate1)
            await vote.save()
        res.status(200).json({message:"Movie voted", vote})
    },
    getResult: async(req, res)=>{
        const {movieId} = req.params
        const movie = await Vote.findById(movieId)
        const movie1 = movie.movie1.percentage
        const movie2 = movie.movie2.percentage
        const sum = movie1 - movie2
        const result = await Vote.findByIdAndUpdate(movieId, {result:sum})
        await result.save()
        if(sum>0){
            const winnerMovie = await Movie.findById(movie.movie1.movieId)
            const winner1 = await Vote.findByIdAndUpdate(movieId, {winner: winnerMovie.title})
            await winner1.save()
            return await res.status(200).json({message:"Winner is", winner1, winnerMovie})
        }
        else if(sum < 0){
            const winnerMovie = await Movie.findById(movie.movie2.movieId)
            const winner2 = await Vote.findByIdAndUpdate(movieId, {winner: winnerMovie.title})
            await winner2.save()

            return await res.status(200).json({message:"Winner is", winner2, winnerMovie})
        }
        else{
            const winner = await Vote.findByIdAndUpdate(movieId, {winner: "Tie"})
            await winner.save()
             return await res.status(200).json({message:"Winner is", winner})
          

        }

    }

}

export default usercontroller